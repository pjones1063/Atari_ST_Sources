; Dma gemread which also handles subdirectories!!
; This was stolen from Powermonger!!

	CLR.L -(SP)
	MOVE #$20,-(SP)
	TRAP #1
	ADDQ.L #6,SP	
	LEA filename(PC),A0
	LEA $78000,A1
	BSR Gemread
	CLR -(SP)
	TRAP #1
filename
	DC.B "GENST2.PRG",0
	EVEN

;-----------------------------------------------;
; The fastest and best dma gem file reader	;
; A0 - ptr to filename.				;
; A1 - ptr to load address!			;
;-----------------------------------------------;

Gemread	MOVEM.L	D1-d7/A0-a4,-(A7)
	MOVEA.L	A0,A4
	BSR	L7662A
	BSR	L766C0
	BMI.S	L76624
	BSR	L76704
	BMI.S	L76624
	BSR	L7678A
L76624	MOVEM.L	(A7)+,D1-D7/A0-A4
	RTS
L7662A	CMPI.B	#$3A,1(A4)
	BNE.S	L7664A
	MOVE.B	(A4)+,D0
	SUBQ.B	#1,D0
	ANDI.B	#1,D0
	LEA	L76885(PC),A0
	MOVE.B	D0,(A0)
	ADDQ.W	#1,A4
	CMPI.B	#$5C,(A4)
	BNE.S	L7664A
	ADDQ.W	#1,A4
L7664A	RTS
L7664C	LEA	L76886(PC),A0
	MOVEQ	#$A,D0
L76652	MOVE.B	#$20,(A0)+
	DBF	D0,L76652
	LEA	L76886(PC),A0
	MOVEQ	#7,D2
	BSR	L7667A
	TST.B	D0
	BEQ.S	L76678
	CMP.B	#$2E,D0
	BNE.S	L76678
	LEA	L7688E(PC),A0
	MOVEQ	#2,D2
	BSR	L7667A
L76678	RTS
L7667A	MOVE.B	(A4),D0
	BEQ.S	L7669C
	ADDQ.W	#1,A4
	BSR	L7669E
	BEQ.S	L7669C
	BSR	L766AE
	MOVE.B	D0,(A0)+
	DBF	D2,L7667A
	MOVE.B	(A4),D0
	BEQ.S	L7669C
	BSR	L7669E
	BNE.S	L7669C
	ADDQ.W	#1,A4
L7669C	RTS
L7669E	TST.B	D0
	BEQ.S	L766AC
	CMP.B	#$2E,D0
	BEQ.S	L766AC
	CMP.B	#$5C,D0
L766AC	RTS
L766AE	CMP.B	#$41,D0
	BLT.S	L766BE
	CMP.B	#$7A,D0
	BGT.S	L766BE
	ANDI.B	#$DF,D0
L766BE	RTS
L766C0	MOVE.L	L76882(PC),D0
	MOVEQ	#0,D1
	MOVEQ	#1,D2
	MOVEQ	#0,D3
	LEA	L76892(PC),A0
	BSR	L76A92
	BNE.S	L76700
	LEA	L7687D(PC),A2
	MOVE.B	$11(A0),(A2)
	LEA	L76881(PC),A2
	MOVE.B	$16(A0),(A2)
	LEA	L76883(PC),A2
	MOVE.B	$18(A0),(A2)
	LEA	L76885(PC),A2
	BCLR	#3,(A2)
	CMPI.B	#1,$1A(A0)
	BEQ.S	L76700
	BSET	#3,(A2)
L76700	TST.L	D0
	RTS
L76704	MOVE.L	L7687E(PC),D1
	ADD.L	D1,D1
	ADDQ.L	#1,D1
	MOVE.L	L7687A(PC),D4
	LSR.L	#4,D4
	BSR	L7664C
L76716	MOVE.L	L76882(PC),D0
	MOVEQ	#1,D2
	MOVEQ	#0,D3
	LEA	L76892(PC),A0
	BSR	L76A92
	BNE.S	L76772
	MOVEQ	#$F,D0
L7672A	BTST	#3,$B(A0)
	BNE.S	L76762
	MOVEA.L	A0,A2
	LEA	L76886(PC),A3
	MOVEQ	#$A,D2
L7673A	CMPM.B	(A2)+,(A3)+
	BNE.S	L76762
	DBF	D2,L7673A
	MOVE.L	$1C(A0),D1
	ROL.W	#8,D1
	SWAP	D1
	ROL.W	#8,D1
	MOVE.W	$1A(A0),D0
	ROL.W	#8,D0
	TST.B	(A4)
	BEQ.S	L76772
	BSR	L76774
	BSR	L7664C
	MOVEQ	#7,D4
	BRA.S	L76716
L76762	LEA	$20(A0),A0
	DBF	D0,L7672A
	ADDQ.L	#1,D1
	SUBQ.L	#1,D4
	BNE.S	L76716
	MOVEQ	#-$21,D0
L76772	RTS
L76774	ADD.L	D0,D0
	MOVE.L	L7687A(PC),D1
	LSR.L	#4,D1
	ADD.L	L7687E(PC),D1
	ADD.L	L7687E(PC),D1
	SUBQ.L	#3,D1
	ADD.L	D0,D1
	RTS
L7678A	LEA	L76892(PC),A0
	MOVE.L	D1,D6
	MOVEQ	#0,D1
L76792	MOVE.L	D0,D2
	MOVE.L	D0,D3
L76796	BSR	L76806
	ADDQ.L	#1,D2
	CMP.L	D2,D0
	BEQ.S	L76796
	MOVE.L	D0,D4
	MOVE.L	D1,D5
	MOVE.L	D3,D0
	BSR	L76774
	SUB.L	D3,D2
	ADD.L	D2,D2
	MOVE.L	D6,D0
	LSR.L	#8,D0
	LSR.L	#1,D0
	BEQ.S	L767EE
	MOVEQ	#0,D7
	CMP.L	D2,D0
	BGE.S	L767C0
	MOVE.L	D0,D2
	MOVEQ	#-1,D7
L767C0	MOVE.L	L76882(PC),D0
	MOVEQ	#0,D3
	EXG	A1,A0
	BSR	L76A92
	BNE.S	L76804
	EXG	A1,A0
	ADD.L	D2,D1
	LSL.L	#8,D2
	ADD.L	D2,D2
	ADDA.L	D2,A1
	SUB.L	D2,D6
	BEQ.S	L76804
	TST.L	D7
	BNE.S	L767EE
	MOVE.L	D4,D0
	MOVE.L	D5,D1
	CMP.W	#$FFF,D0
	BNE.S	L76792
	MOVEQ	#-1,D0
	BRA.S	L76804
L767EE	MOVE.L	L76882(PC),D0
	MOVEQ	#1,D2
	MOVEQ	#0,D3
	BSR	L76A92
	BNE.S	L76804
L767FC	MOVE.B	(A0)+,(A1)+
	SUBQ.L	#1,D6
	BNE.S	L767FC
	MOVEQ	#0,D0
L76804	RTS
L76806	MOVEM.L	D2-D6,-(A7)
	MOVE.L	D0,D5
	MOVE.L	D0,D6
	LSR.L	#1,D0
	ADD.L	D0,D5
	DIVU	#$200,D5
	ADDQ.W	#1,D5
	CMP.W	D1,D5
	BEQ.S	L7682C
	MOVE.W	D5,D1
	MOVE.L	L76882(PC),D0
	MOVEQ	#1,D2
	MOVEQ	#0,D3
	BSR	L76A92
	BNE.S	L76874
L7682C	SWAP	D5
	MOVE.B	0(A0,D5.W),D4
	ADDQ.W	#1,D5
	CMP.W	#$200,D5
	BLT.S	L7684C
	MOVEQ	#0,D5
	ADDQ.L	#1,D1
	MOVE.L	L76882(PC),D0
	MOVEQ	#1,D2
	MOVEQ	#0,D3
	BSR	L76A92
	BNE.S	L76874
L7684C	MOVE.B	0(A0,D5.W),D5
	BTST	#0,D6
	BNE.S	L76862
	ANDI.W	#$FF,D4
	ANDI.W	#$F,D5
	LSL.W	#8,D5
	BRA.S	L7686E
L76862	ANDI.W	#$F0,D4
	ANDI.W	#$FF,D5
	LSL.W	#4,D5
	LSR.W	#4,D4
L7686E	OR.W	D5,D4
	MOVEQ	#0,D0
	MOVE.W	D4,D0
L76874	MOVEM.L	(A7)+,D2-D6
	RTS
L7687A	DS.B 3
L7687D	DS.B 1
L7687E	DS.B 3
L76881	DS.B 1
L76882	DC.B 0
L76883	DC.B 0
L76884	DC.B 0
L76885	DC.B 0
L76886	ORI.B	#0,D0
	ORI.B	#0,D0
L7688E	ORI.B	#0,D0
L76892	DS.B 512
L76A92	MOVEM.L	D1-D4/A0-A1,-(A7)
	LINK	A6,#-$1E
	MOVE.L	D0,D4
	ANDI.W	#1,D0
	MOVE.W	D0,-$1C(A6)
	SWAP	D0
	CMP.W	#9,D0
	BLT.S	L76AB2
	CMP.W	#$B,D0
	BLE.S	L76AB6
L76AB2	MOVE.W	#$A,D0
L76AB6	MOVE.W	D0,-$1E(A6)
	MOVE.W	D1,-$16(A6)
	MOVE.W	D2,-$12(A6)
	MOVE.W	D3,-8(A6)
	MOVE.L	A0,-$C(A6)
	ROR.L	#3,D4
	ANDI.W	#1,D4
	EORI.B	#1,D4
	ADDQ.B	#1,D4
	MOVE.W	D4,-$10(A6)
	CLR.W	D4
	ROL.L	#1,D4
	MOVE.W	D4,-$E(A6)
	MOVEQ	#$15,D0
	ADD.W	D1,D2
	MOVE.W	-$1E(A6),D3
	MULU	#$A0,D3
	CMP.W	D3,D2
	BGT	L76B90
	EXT.L	D1
	DIVU	-$1E(A6),D1
	CMPI.W	#1,-$10(A6)
	BEQ.S	L76B04
	ADD.W	D1,D1
L76B04	MOVE.W	D1,-$1A(A6)
	SWAP	D1
	ADDQ.W	#1,D1
	MOVE.W	D1,-$18(A6)
	BSR	L76E36
L76B14	MOVE.W	-$18(A6),D0
	MOVE.W	-$1E(A6),D1
	ADDQ.W	#1,D1
	SUB.W	D0,D1
	CMP.W	-$12(A6),D1
	BLE.S	L76B2A
	MOVE.W	-$12(A6),D1
L76B2A	MOVE.W	D1,-$14(A6)
	BSR	L76B9E
	BNE.S	L76B66
	MOVE.W	-$12(A6),D0
	SUB.W	-$14(A6),D0
	BEQ.S	L76B66
	MOVE.W	D0,-$12(A6)
	MOVE.W	#1,-$18(A6)
	MOVE.W	-$10(A6),D0
	ADD.W	D0,-$1A(A6)
	CMPI.B	#2,-7(A6)
	BEQ.S	L76B14
	MOVE.W	-$14(A6),D0
	LSL.L	#8,D0
	ADD.L	D0,D0
	ADD.L	D0,-$C(A6)
	BRA.S	L76B14
L76B66	MOVE.L	D0,D1
	BEQ.S	L76B90
	ANDI.B	#$58,D0
	MOVEQ	#$1C,D1
	CMP.B	#$40,D0
	BEQ.S	L76B90
	MOVEQ	#$19,D1
	CMP.B	#8,D0
	BEQ.S	L76B90
	MOVEQ	#$18,D1
	CMP.B	#$18,D0
	BEQ.S	L76B90
	MOVEQ	#$15,D1
	CMP.B	#$10,D0
	BEQ.S	L76B90
	MOVEQ	#-1,D1
L76B90	BSR	L76E68
	UNLK	A6
	MOVE.L	D1,D0
	MOVEM.L	(A7)+,D1-D4/A0-A1
	RTS
L76B9E	BSR	L76EA0
	MOVE.W	#2,D3
	BRA.S	L76BB2
L76BA8	CMP.B	#$10,D0
	BNE.S	L76BBC
	BSR	L76E20
L76BB2	MOVE.W	-$1A(A6),D0
	LSR.W	#1,D0
	BSR	L76E04
L76BBC	MOVEA.L	-$C(A6),A0
	MOVE.W	-$18(A6),D1
	MOVE.W	-$14(A6),D2
	BSR	L76BDC
	TST.W	D0
	BEQ.S	L76BDA
	CMP.B	#$40,D0
	DBEQ	D3,L76BA8
	TST.W	D0
L76BDA	RTS
L76BDC	TST.B	-7(A6)
	BEQ.S	L76BE6
	BRA	L76C6E
L76BE6	BSR	L76DE4
	MOVE.W	#$90,$FFFF8606.W
	MOVE.W	#$190,$FFFF8606.W
	MOVE.W	#$90,$FFFF8606.W
	MOVEQ	#0,D0
	MOVE.W	D2,D0
	BSR	L76F60
	LSL.L	#8,D0
	ADD.L	D0,D0
	MOVEA.L	A0,A1
	ADDA.L	D0,A1
	MOVE.W	#$80,$FFFF8606.W
	MOVE.W	#$90,D0
	BSR	L76F60
	MOVE.L	#$40000,D0
	CLR.L	-4(A6)
L76C24	BTST	#5,$FFFFFA01.W
	BEQ.S	L76C4C
	SUBQ.L	#1,D0
	BEQ.S	L76C66
	MOVE.B	$FFFF8609.W,-3(A6)
	MOVE.B	$FFFF860B.W,-2(A6)
	MOVE.B	$FFFF860D.W,-1(A6)
	CMPA.L	-4(A6),A1
	BGT.S	L76C24
	BSR	L76F2C
L76C4C	MOVE.W	#$90,$FFFF8606.W
	MOVE.W	$FFFF8606.W,D0
	BTST	#0,D0
	BEQ.S	L76C6A
	BSR	L76F4A
	ANDI.B	#$18,D0
	RTS
L76C66	BSR	L76F2C
L76C6A	MOVEQ	#-1,D0
	RTS
L76C6E	BSR	L76DE4
	MOVE.W	#$190,$FFFF8606.W
	MOVE.W	#$90,$FFFF8606.W
	MOVE.W	#$190,$FFFF8606.W
	MOVEQ	#1,D0
	CMPI.B	#1,-7(A6)
	BEQ.S	L76C90
	MOVEQ	#$1F,D0
L76C90	BSR	L76F60
	MOVE.W	#$180,$FFFF8606.W
	MOVE.W	#$A0,D0
	CMPI.B	#1,-7(A6)
	BEQ.S	L76CBC
	BSR	L76EC6
	MOVE.W	D0,D1
	MOVE.W	-$1A(A6),D0
	LSR.W	#1,D0
	BSR	L76CF0
	MOVE.W	#$F0,D0
	MOVEQ	#1,D2
L76CBC	BSR	L76F60
	MOVE.L	#$40000,D0
L76CC6	BTST	#5,$FFFFFA01.W
	BEQ.S	L76CDA
	SUBQ.L	#1,D0
	BNE.S	L76CC6
	BSR	L76F2C
	MOVEQ	#-1,D0
	RTS
L76CDA	BSR	L76F42
	ANDI.B	#$5C,D0
	BNE.S	L76CEE
	LEA	$200(A0),A0
	ADDQ.B	#1,D1
	SUBQ.B	#1,D2
	BNE.S	L76C6E
L76CEE	RTS
L76CF0	MOVEM.L	D0-D5/A0,-(A7)
	MOVE.L	D0,D4
	MOVE.L	D1,D5
	MULU	#$14,D0
	BSR	L76DA6
	MOVE.W	D0,D2
	MOVE.B	#$4E,D0
	MOVEQ	#$3C,D1
	BSR	L76D80
	MOVE.W	-$1E(A6),D3
L76D10	MOVEQ	#0,D0
	MOVEQ	#$C,D1
	BSR	L76D80
	MOVE.B	#$F5,D0
	MOVEQ	#3,D1
	BSR	L76D80
	MOVE.B	#$FE,(A0)+
	MOVE.B	D4,(A0)+
	MOVE.B	D5,(A0)+
	CMP.B	-$1D(A6),D2
	BLE.S	L76D32
	MOVEQ	#1,D2
L76D32	MOVE.B	D2,(A0)+
	MOVE.B	#2,(A0)+
	MOVE.B	#$F7,(A0)+
	MOVE.B	#$4E,D0
	MOVEQ	#$16,D1
	BSR	L76D80
	MOVEQ	#0,D0
	MOVEQ	#$C,D1
	BSR	L76D80
	MOVE.B	#$F5,D0
	MOVEQ	#3,D1
	BSR	L76D80
	MOVE.B	#$FB,(A0)+
	BSR	L76D88
	MOVE.B	#$F7,(A0)+
	MOVE.B	#$4E,D0
	MOVEQ	#$28,D1
	BSR	L76D80
	ADDQ.B	#1,D2
	SUBQ.W	#1,D3
	BNE.S	L76D10
	MOVEQ	#$64,D1
	BSR	L76D80
	MOVEM.L	(A7)+,D0-D5/A0
	RTS
L76D80	MOVE.B	D0,(A0)+
	SUBQ.L	#1,D1
	BNE.S	L76D80
	RTS
L76D88	MOVE.W	#$A9,D0
L76D8C	MOVE.B	#$6D,(A0)+
	MOVE.B	#$B6,(A0)+
	MOVE.B	#$DB,(A0)+
	DBF	D0,L76D8C
	MOVE.B	#$6D,(A0)+
	MOVE.B	#$B6,(A0)+
	RTS
L76DA6	MOVE.L	D1,-(A7)
	ANDI.L	#$FFFF,D0
	DIVU	#$64,D0
	SWAP	D0
	ANDI.L	#$FFFF,D0
	DIVU	#$14,D0
	ADD.W	D0,D0
	SUBI.W	#$A,D0
	NEG.W	D0
	MOVE.L	D0,D1
	SWAP	D1
	ADD.W	D1,D0
	ANDI.L	#$FFFF,D0
	DIVU	#$A,D0
	SWAP	D0
	ADDQ.B	#1,D0
	ANDI.L	#$FFFF,D0
	MOVE.L	(A7)+,D1
	RTS
L76DE4	MOVE.L	A0,D0
	MOVE.B	D0,$FFFF860D.W
	LSR.L	#8,D0
	MOVE.B	D0,$FFFF860B.W
	LSR.L	#8,D0
	MOVE.B	D0,$FFFF8609.W
	MOVE.W	#$84,$FFFF8606.W
	MOVE.W	D1,D0
	BSR	L76F60
	RTS
L76E04	TST.W	D0
	BEQ.S	L76E20
	MOVE.W	#$86,$FFFF8606.W
	BSR	L76F60
	MOVE.W	#$10,D0
	BSR	L76EFE
	BMI.S	L76E1E
	MOVEQ	#0,D0
L76E1E	RTS
L76E20	MOVEQ	#0,D0
	BSR	L76EFE
	BMI.S	L76E34
	EORI.B	#4,D0
	BTST	#2,D0
	BNE.S	L76E34
	MOVEQ	#0,D0
L76E34	RTS
L76E36	MOVE.W	$43E.W,-6(A6)
	ST	$43E.W
	BSR	L76EA0
	MOVE.W	-$1C(A6),D0
	ADD.W	D0,D0
	MOVE.W	#$82,$FFFF8606.W
	LEA	L76F7E(PC),A0
	MOVE.W	0(A0,D0.W),D0
	LSR.W	#1,D0
	BSR	L76F60
	CMP.W	#$A0,D0
	BLT.S	L76E66
	BSR.S	L76E20
L76E66	RTS
L76E68	MOVEM.L	D0-D1,-(A7)
	MOVE.W	-$1C(A6),D0
	ADD.W	D0,D0
	LEA	L76F7E(PC),A0
	MOVE.W	-$1A(A6),D1
	MOVE.W	D1,0(A0,D0.W)
	TST.W	-8(A6)
	BPL.S	L76E8E
	MOVE.L	#$C3500,D0
	BSR	L76F78
L76E8E	MOVEQ	#7,D0
	BSR	L76EE0
	MOVE.W	-6(A6),$43E.W
	MOVEM.L	(A7)+,D0-D1
	RTS
L76EA0	MOVE.W	D0,-(A7)
	MOVE.W	-$1C(A6),D0
	ANDI.W	#1,D0
	ADDQ.B	#1,D0
	ADD.B	D0,D0
	MOVE.W	D0,-(A7)
	BSR	L76EC6
	OR.W	(A7)+,D0
	EORI.B	#7,D0
	ANDI.B	#7,D0
	BSR	L76EE0
	MOVE.W	(A7)+,D0
	RTS
L76EC6	MOVE.W	-$10(A6),D0
	CMP.W	#1,D0
	BEQ.S	L76ED6
	MOVE.W	-$E(A6),D0
	BRA.S	L76EDE
L76ED6	MOVE.W	-$1A(A6),D0
	ANDI.W	#1,D0
L76EDE	RTS
L76EE0	MOVE	SR,-(A7)
	ORI.W	#$700,SR
	MOVE.B	#$E,$FFFF8800.W
	MOVE.B	$FFFF8800.W,D1
	ANDI.B	#$F8,D1
	OR.B	D0,D1
	MOVE.B	D1,$FFFF8802.W
	MOVE.W	(A7)+,SR
	RTS
L76EFE	CMP.B	#$80,D0
	BCC.S	L76F08
	ORI.B	#3,D0
L76F08	MOVE.W	#$80,$FFFF8606.W
	BSR	L76F60
	MOVE.L	#$60000,D0
L76F18	BTST	#5,$FFFFFA01.W
	BEQ.S	L76F4A
	SUBQ.L	#1,D0
	BNE.S	L76F18
	BSR	L76F2C
	MOVEQ	#-1,D0
	RTS
L76F2C	MOVE.W	#$80,$FFFF8606.W
	MOVE.W	#$D0,D0
	BSR	L76F60
	MOVEQ	#$F,D0
	BSR	L76F78
	BRA.S	L76F4A
L76F42	MOVE.W	#$180,$FFFF8606.W
	BRA.S	L76F50
L76F4A	MOVE.W	#$80,$FFFF8606.W
L76F50	BSR	L76F68
	MOVE.W	$FFFF8604.W,D0
	ANDI.L	#$FF,D0
	BRA.S	L76F68
L76F60	BSR	L76F68
	MOVE.W	D0,$FFFF8604.W
L76F68	MOVE	SR,-(A7)
	MOVE.W	D0,-(A7)
	MOVEQ	#$18,D0
	BSR	L76F78
	MOVE.W	(A7)+,D0
	MOVE.W	(A7)+,SR
	RTS
L76F78	SUBQ.L	#1,D0
	BNE.S	L76F78
	RTS
L76F7E	DC.L	-1
	DC.L 	-1
