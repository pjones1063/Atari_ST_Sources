*** SYSTEM INITS

SAVE_SYSTEM	MOVE.L	#BUFFER,A0
	MOVEC	CACR,D0
	MOVE.W	D0,(A0)+		; CACHE
	MOVE.B	$FFFF8007.W,(A0)+	; CONFIG 030
	MOVE.B	$FFFF8201.W,(A0)+	; VIDEO (POIDS FORT)
	MOVE.B	$FFFF8203.W,(A0)+	; VIDEO (POIDS MOY)
	MOVE.B	$FFFF820D.W,(A0)+	; VIDEO (POIDS FAIBLE)
	MOVE.B	$FFFF820A.W,(A0)+	; SYNCHRO VIDEO
	MOVE.W	$FFFF820E.W,(A0)+	; OFFSET PROCHAINE LIGNE
	MOVE.W	$FFFF8210.W,(A0)+	; LARGEUR D'UNE LIGNE
	MOVE.B	$FFFF8260.W,(A0)+	; RESO ST
	MOVE.W	$FFFF8266.W,(A0)+	; RESO FALCON
	MOVE.W	$FFFF8282.W,(A0)+	; HHT-SYNCHRO
	MOVE.W	$FFFF8284.W,(A0)+	; FIN DECODAGE DE LIGNE
	MOVE.W	$FFFF8286.W,(A0)+	; DEBUT DECODADAGE DE LIGNE
	MOVE.W	$FFFF8288.W,(A0)+	; OVERSCAN GAUCHE
	MOVE.W	$FFFF828A.W,(A0)+	; OVERSCAN DROITE
	MOVE.W	$FFFF828C.W,(A0)+	; HSS-SYNCHRO
	MOVE.W	$FFFF828E.W,(A0)+	; HFS
	MOVE.W	$FFFF8290.W,(A0)+	; HEE
	MOVE.W	$FFFF82A2.W,(A0)+	; VFT-SYNCHRO
	MOVE.W	$FFFF82A4.W,(A0)+	; FIN DECODAGE IMAGE
	MOVE.W	$FFFF82A6.W,(A0)+	; DEBUT DECODAGE IMAGE
	MOVE.W	$FFFF82A8.W,(A0)+	; OVERSCAN HAUT
	MOVE.W	$FFFF82AA.W,(A0)+	; OVERSCAN BAS
	MOVE.W	$FFFF82AC.W,(A0)+	; VSS-SYNCHRO
	MOVE.W	$FFFF82C0.W,(A0)+	; RECONNAISSANCE ST/FALCON
	MOVE.W	$FFFF82C2.W,(A0)+	; INFO RESO	
	MOVE.B	$FFFFFA01.W,(A0)+	; REGISTRE GPIP
	MOVE.B	$FFFFFA03.W,(A0)+	; REGISTRE AER
	MOVE.B	$FFFFFA05.W,(A0)+	; REGISTRE DDR
	MOVE.B	$FFFFFA07.W,(A0)+	; REGISTRE IERA
	MOVE.B	$FFFFFA09.W,(A0)+	; REGISTRE IERB
	MOVE.B	$FFFFFA0B.W,(A0)+	; REGISTRE IPRA
	MOVE.B	$FFFFFA0D.W,(A0)+	; REGISTRE IPRB
	MOVE.B	$FFFFFA0F.W,(A0)+	; REGISTRE ISRA
	MOVE.B	$FFFFFA11.W,(A0)+	; REGISTRE ISRB
	MOVE.B	$FFFFFA13.W,(A0)+	; REGISTRE IMRA
	MOVE.B	$FFFFFA15.W,(A0)+	; REGISTRE IMRB
	MOVE.B	$FFFFFA17.W,(A0)+	; REGISTRE VR
	MOVE.B	$FFFFFA19.W,(A0)+	; CONTROLE TIMER A
	MOVE.B	$FFFFFA1B.W,(A0)+	; CONTROLE TIMER B
	MOVE.B	$FFFFFA1D.W,(A0)+	; CONTROLE TIMER C ET D
	MOVE.B	$FFFFFA1F.W,(A0)+	; DONNEE TIMER A
	MOVE.B	$FFFFFA21.W,(A0)+	; DONNEE TIMER B
	MOVE.B	$FFFFFA23.W,(A0)+	; DONNER TIMER C
	MOVE.B	$FFFFFA25.W,(A0)+	; DONNEE TIMER D
	MOVE.B	$FFFFFA27.W,(A0)+	; REGISTRE UCR
	MOVE.B	$FFFFFA2B.W,(A0)+	; REGISTRE RSR
	MOVE.B	$FFFFFA2D.W,(A0)+	; REGISTRE TSR
	MOVE.B	$FFFFFA2F.W,(A0)+	; REGISTRE UDR
	MOVE.L	$8.W,(A0)+		; BUS ERROR
	MOVE.L	$10.W,(A0)+		; ILLEGAL ERROR
	MOVE.L	$14.W,(A0)+		; DIV0 ERROR
	MOVE.L	$68.W,(A0)+		; ADRESSE HBL
	MOVE.L	$70.W,(A0)+		; ADRESSE VBL
	MOVE.L	$110.W,(A0)+	; ADRESSE TIMER D
	MOVE.L	$114.W,(A0)+	; ADRESSE TIMER C
	MOVE.L	$120.W,(A0)+	; ADRESSE TIMER B
	MOVE.L	$134.W,(A0)+	; ADRESSE TIMER A
	
PALETTE_ST	LEA	$FFFF8240.W,A1
	MOVEQ	#7,D0
SAV_ST_PAL	MOVE.L	(A1)+,(A0)+
	DBF	D0,SAV_ST_PAL
	
PALETTE_FAL	LEA	$FFFF9800.W,A1
	MOVE.W	#$FF,D0
SAV_FAL_PAL	MOVE.L	(A1)+,(A0)+
	DBF	D0,SAV_FAL_PAL
	
	RTS	

REST_SYSTEM	MOVE.L	#BUFFER,A0
	MOVE.W	(A0)+,D0
	MOVEC	D0,CACR		; CACHE
	MOVE.B	(A0)+,$FFFF8007.W	; CONFIG 030
	MOVE.B	(A0)+,$FFFF8201.W	; VIDEO (POIDS FORT)
	MOVE.B	(A0)+,$FFFF8203.W	; VIDEO (POIDS MOY)
	MOVE.B	(A0)+,$FFFF820D.W	; VIDEO (POIDS FAIBLE)
	MOVE.B	(A0)+,$FFFF820A.W	; SYNCHRO VIDEO
	MOVE.W	(A0)+,$FFFF820E.W	; OFFSET PROCHAINE LIGNE
	MOVE.W	(A0)+,$FFFF8210.W	; LARGEUR D'UNE LIGNE
	MOVE.B	(A0)+,D0		; RESO ST
	MOVE.W	(A0)+,D1		; RESO FALCON
	MOVE.W	(A0)+,$FFFF8282.W	; HHT-SYNCHRO
	MOVE.W	(A0)+,$FFFF8284.W	; FIN DECODAGE DE LIGNE
	MOVE.W	(A0)+,$FFFF8286.W	; DEBUT DECODADAGE DE LIGNE
	MOVE.W	(A0)+,$FFFF8288.W	; OVERSCAN GAUCHE
	MOVE.W	(A0)+,$FFFF828A.W	; OVERSCAN DROITE
	MOVE.W	(A0)+,$FFFF828C.W	; HSS-SYNCHRO
	MOVE.W	(A0)+,$FFFF828E.W	; HFS
	MOVE.W	(A0)+,$FFFF8290.W	; HEE
	MOVE.W	(A0)+,$FFFF82A2.W	; VFT-SYNCHRO
	MOVE.W	(A0)+,$FFFF82A4.W	; FIN DECODAGE IMAGE
	MOVE.W	(A0)+,$FFFF82A6.W	; DEBUT DECODAGE IMAGE
	MOVE.W	(A0)+,$FFFF82A8.W	; OVERSCAN HAUT
	MOVE.W	(A0)+,$FFFF82AA.W	; OVERSCAN BAS
	MOVE.W	(A0)+,$FFFF82AC.W	; VSS-SYNCHRO
	MOVE.W	(A0)+,$FFFF82C0.W	; RECONNAISSANCE ST/FALCON
	MOVE.W	(A0)+,$FFFF82C2.W	; INFO RESO	
	MOVE.B	(A0)+,$FFFFFA01.W	; REGISTRE GPIP
	MOVE.B	(A0)+,$FFFFFA03.W	; REGISTRE AER
	MOVE.B	(A0)+,$FFFFFA05.W	; REGISTRE DDR
	MOVE.B	(A0)+,$FFFFFA07.W	; REGISTRE IERA
	MOVE.B	(A0)+,$FFFFFA09.W	; REGISTRE IERB
	MOVE.B	(A0)+,$FFFFFA0B.W	; REGISTRE IPRA
	MOVE.B	(A0)+,$FFFFFA0D.W	; REGISTRE IPRB
	MOVE.B	(A0)+,$FFFFFA0F.W	; REGISTRE ISRA
	MOVE.B	(A0)+,$FFFFFA11.W	; REGISTRE ISRB
	MOVE.B	(A0)+,$FFFFFA13.W	; REGISTRE IMRA
	MOVE.B	(A0)+,$FFFFFA15.W	; REGISTRE IMRB
	MOVE.B	(A0)+,$FFFFFA17.W	; REGISTRE VR
	MOVE.B	(A0)+,$FFFFFA19.W	; CONTROLE TIMER A
	MOVE.B	(A0)+,$FFFFFA1B.W	; CONTROLE TIMER B
	MOVE.B	(A0)+,$FFFFFA1D.W	; CONTROLE TIMER C ET D
	MOVE.B	(A0)+,$FFFFFA1F.W	; DONNEE TIMER A
	MOVE.B	(A0)+,$FFFFFA21.W	; DONNEE TIMER B
	ADDQ.W	#1,A0
;	MOVE.B	(A0)+,D3		; $FFFFFA23.W DONNEE TIMER C
	MOVE.B	(A0)+,$FFFFFA25.W	; DONNEE TIMER D
	MOVE.B	(A0)+,$FFFFFA27.W	; REGISTRE UCR
	MOVE.B	(A0)+,$FFFFFA2B.W	; REGISTRE RSR
	MOVE.B	(A0)+,$FFFFFA2D.W	; REGISTRE TSR
	MOVE.B	(A0)+,$FFFFFA2F.W	; REGISTRE UDR
	MOVE.L	(A0)+,$8.W		; BUS ERROR
	MOVE.L	(A0)+,$10.W		; ILLEGAL ERROR
	MOVE.L	(A0)+,$14.W		; DIV0 ERROR
	MOVE.L	(A0)+,$68.W		; ADRESSE HBL
	MOVE.L	(A0)+,$70.W		; ADRESSE VBL
	MOVE.L	(A0)+,$110.W	; ADRESSE TIMER D
	MOVE.L	(A0)+,$114.W	; ADRESSE TIMER C
	MOVE.L	(A0)+,$120.W	; ADRESSE TIMER B
	MOVE.L	(A0)+,$134.W	; ADRESSE TIMER A
	
	BTST	#0,$FFFF82C0.W
	BNE.S	FAL_REZO
	MOVE.W	D1,$FFFF8266.W
	MOVE.B	D0,$FFFF8260.W
	BRA.S	.PALETTE_ST
FAL_REZO	MOVE.W	D1,$FFFF8266.W
.PALETTE_ST	LEA	$FFFF8240.W,A1
	MOVEQ	#7,D0
RES_ST_PAL	MOVE.L	(A0)+,(A1)+
	DBF	D0,RES_ST_PAL
	
.PALETTE_FAL	
	LEA	$FFFF9800.W,A1
	MOVE.W	#$FF,D0
RES_FAL_PAL	MOVE.L	(A0)+,(A1)+
	DBF	D0,RES_FAL_PAL

	RTS	
	
INIT_SYSTEM	MOVEC	CACR,D0
	MOVE.W	#$2D0D,D0
	MOVEC	D0,CACR		; CACHE
	MOVE.B	#5,$FFFF8007.W	; 16 MHZ 030
	
	MOVE.L	ECRAN1,D0		; ADRESSE ECRAN
	LSR.W	#8,D0
	MOVE.L	D0,$FFFF8200.W
	MOVE.L	ECRAN1,D0	
	MOVE.B	D0,$FFFF820D.W	
	
	MOVE.B	(A0)+,$FFFF8260.W	; RESO ST
	MOVE.B	(A0)+,$FFFF820A.W	; SYNCHRO ST
	MOVE.W	(A0)+,$FFFF820E.W	; OFFSET PROCHAINE LIGNE 
	MOVE.W	(A0)+,$FFFF8210.W	; LARGEUR D'UNE LIGNE
	CMPI.B	#128,$FFFF8006.W	; VGA ?
	BHS.S	VGA

RGB	MOVE.W	(A0)+,$FFFF8266.W	; REZO FALCON
	MOVE.W	(A0)+,$FFFF8286.W	; DEBUT DECODADAGE DE LIGNE
	MOVE.W	(A0)+,$FFFF8284.W	; FIN DECODAGE DE LIGNE
	MOVE.W	(A0)+,$FFFF8288.W	; OVERSCAN GAUCHE
	MOVE.W	(A0)+,$FFFF828A.W	; OVERSCAN DROITE
	MOVE.W	(A0)+,$FFFF82A6.W	; DEBUT DECODAGE IMAGE
	MOVE.W	(A0)+,$FFFF82A4.W	; FIN DECODAGE IMAGE
	MOVE.W	(A0)+,$FFFF82A8.W	; OVERSCAN HAUT
	MOVE.W	(A0)+,$FFFF82AA.W	; OVERSCAN BAS
	MOVE.W	(A0)+,$FFFF82C0.W	; RECONNAISSANCE ST/FALCON
	MOVE.W	(A0)+,$FFFF82C2.W	; INFO RESO	
	MOVE.W	(A0)+,$FFFF8282.W	; HHT-SYNCHRO
	MOVE.W	(A0)+,$FFFF828C.W	; HSS-SYNCHRO
	MOVE.W	(A0)+,$FFFF828E.W	; HFS
	MOVE.W	(A0)+,$FFFF8290.W	; HEE
	MOVE.W	(A0)+,$FFFF82A2.W	; VFT-SYNCHRO
	MOVE.W	(A0)+,$FFFF82AC.W	; VSS-SYNCHRO
	
	BRA.S	SUITE_INIT
	
VGA	MOVE.W	(A1)+,$FFFF8266.W	; REZO FALCON
	MOVE.W	(A1)+,$FFFF8286.W	; DEBUT DECODADAGE DE LIGNE
	MOVE.W	(A1)+,$FFFF8284.W	; FIN DECODAGE DE LIGNE
	MOVE.W	(A1)+,$FFFF8288.W	; OVERSCAN GAUCHE
	MOVE.W	(A1)+,$FFFF828A.W	; OVERSCAN DROITE
	MOVE.W	(A1)+,$FFFF82A6.W	; DEBUT DECODAGE IMAGE
	MOVE.W	(A1)+,$FFFF82A4.W	; FIN DECODAGE IMAGE
	MOVE.W	(A1)+,$FFFF82A8.W	; OVERSCAN HAUT
	MOVE.W	(A1)+,$FFFF82AA.W	; OVERSCAN BAS
	MOVE.W	(A1)+,$FFFF82C0.W	; RECONNAISSANCE ST/FALCON
	MOVE.W	(A1)+,$FFFF82C2.W	; INFO RESO	
	MOVE.W	(A1)+,$FFFF8282.W	; HHT-SYNCHRO
	MOVE.W	(A1)+,$FFFF828C.W	; HSS-SYNCHRO
	MOVE.W	(A1)+,$FFFF828E.W	; HFS
	MOVE.W	(A1)+,$FFFF8290.W	; HEE
	MOVE.W	(A1)+,$FFFF82A2.W	; VFT-SYNCHRO
	MOVE.W	(A1)+,$FFFF82AC.W	; VSS-SYNCHRO
	
SUITE_INIT	
;	CLR.B	$FFFFFA07.W		; REGISTRE IERA
;	CLR.B	$FFFFFA09.W		; REGISTRE IERB
;	CLR.B	$FFFFFA0B.W		; REGISTRE IPRA
;	CLR.B	$FFFFFA0D.W		; REGISTRE IPRB
;	CLR.B	$FFFFFA0F.W		; REGISTRE ISRA
;	CLR.B	$FFFFFA11.W		; REGISTRE ISRB
;	CLR.B	$FFFFFA13.W		; REGISTRE IMRA
;	CLR.B	$FFFFFA15.W		; REGISTRE IMRB
;	BCLR	#3,$FFFFFA17.W	; REGISTRE VR
;	CLR.B	$FFFFFA19.W		; CONTROLE TIMER A
;	CLR.B	$FFFFFA1B.W		; CONTROLE TIMER B
;	CLR.B	$FFFFFA1D.W		; CONTROLE TIMER C ET D
;	CLR.B	$FFFFFA1F.W		; DONNEE TIMER A
;	CLR.B	$FFFFFA21.W		; DONNEE TIMER B
;	CLR.B	$FFFFFA23.W		; DONNER TIMER C
;	CLR.B	$FFFFFA25.W		; DONNEE TIMER D

;	MOVE.L	#BUS_ERROR,$8.W	; BUS ERROR
;	MOVE.L	#ILG_ERROR,$10.W	; ILLEGAL ERROR
;	MOVE.L	#DIV_ERROR,$14.W	; DIV0 ERROR
;	MOVE.L	#NEW_HBL,$68.W	; ADRESSE HBL
;	MOVE.L	#NEW_VBL,$70.W	; ADRESSE VBL
	
;	CLR.L	$110.W		; ADRESSE TIMER D
;	CLR.L	$114.W		; ADRESSE TIMER C
;	CLR.L	$120.W		; ADRESSE TIMER B
;	CLR.L	$134.W		; ADRESSE TIMER A
	
	RTS	


WAIT_KEY	CMP.B	#$80+$39,$FFFFFC02.W
	BNE	WAIT_KEY
	RTS
		
INIT_KEY	MOVE.B	$484.W,KEYBOARD	; COUPE LE CLAVIER
	CLR.B	$484.W
	DC.W	$A00A
	MOVE.B	#$12,$FFFFFC02.W	; COUPE LA SOURIS
	RTS

REST_KEY	DC.W	$A009
	MOVE.B	#8,$FFFFFC02.W
	MOVE.B	KEYBOARD,$484.W
	RTS