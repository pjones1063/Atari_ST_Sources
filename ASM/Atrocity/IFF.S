******************************
**** FORMAT IFF ANIMATION ****
******* CODED BY ZANAK *******
** (C) 1994 , ATROCITY CORP **
******************************

	SECTION TEXT
	
SUPER	CLR.L	-(SP)
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP
	
	MOVE.L	#IFF,A0
	MOVE.L	$44E,A1
	CLR.L	D0
	CLR.L	D2
		
** RECHERCHE DU CHECK ID VDAT

VDAT	MOVE.L	(A0)+,D0
	CMP.L	#'VDAT',D0
	BNE	VDAT
	
	CLR.L	D0
	BSR	DECOMPRESS
	
	BSR	VISUALISATION_IMAGE

BYE	CMP.B	#$39+$80,$FFFFFC02.W
	BNE	BYE
	

	CLR.L	-(SP)
	TRAP	#1
	
*** DECOMPRESSION FORMAT PACKBITS

DECOMPRESS	ADDQ.L	#1,D2
	MOVE.L	(A0),D0
	CMP.L	#'VDAT',D0
	BEQ	FIN
	CLR.L	D0
	MOVE.B	(A0)+,D0
;	EOR.B	#$80,D0
	CMP.B	#-128,D0
	BEQ	DECOMPRESS
	CMP.B	#0,D0
	BGE	X_PLUS_UN_OCTETS
	CMP.B	#-127,D0
	BGE	UN_MOINS_X_OCTETS
	BRA	DECOMPRESS
FIN	RTS
	
X_PLUS_UN_OCTETS
	MOVE.B	(A0)+,(A1)+
	DBF	D0,X_PLUS_UN_OCTETS
	BRA	DECOMPRESS
	
UN_MOINS_X_OCTETS
	MOVE.L	#1,D1
	SUB.B	D1,D0
UN_MOINS_X	MOVE.B	(A0),(A1)+
	DBF	D0,UN_MOINS_X
	BRA	DECOMPRESS

VISUALISATION_IMAGE
	MOVE.L	$44E,A0
	MOVE.L	#BUFFER_IFF,A1
	MOVE.L	#32000,D0
AFFICHE	MOVE.B	(A1)+,(A0)+
	DBF	D0,AFFICHE
	RTS
	
	SECTION DATA
	
IFF	INCBIN	D:\TEST.IFF

	SECTION BSS

BUFFER_IFF	DS.B	32000

	END
	
	